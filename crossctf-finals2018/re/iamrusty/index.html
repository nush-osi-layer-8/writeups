



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Our CTF writeups">
      
      
        <link rel="canonical" href="https://osilayer8.makerforce.io/crossctf-finals2018/re/iamrusty/">
      
      
        <meta name="author" content="OSI Layer 8">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.2">
    
    
      
        <title>iamrusty - OSI Layer 8</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#03a9f4">
      
    
    
      <script src="../../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="light-blue" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#crossctf-finals-2018-rochefort-8-re" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://osilayer8.makerforce.io/" title="OSI Layer 8" class="md-header-nav__button md-logo">
          
            <img src="../../../img/logo_white.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              OSI Layer 8
            </span>
            <span class="md-header-nav__topic">
              
                iamrusty
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/nushosilayer8/writeups/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    nushosilayer8
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://osilayer8.makerforce.io/" title="OSI Layer 8" class="md-nav__button md-logo">
      
        <img src="../../../img/logo_white.svg" width="48" height="48">
      
    </a>
    OSI Layer 8
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/nushosilayer8/writeups/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    nushosilayer8
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Competitions
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Competitions
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      CrossCTF 2018 Qualifiers
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        CrossCTF 2018 Qualifiers
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/CYOA/" title="CYOA" class="md-nav__link">
      CYOA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/pwn/evenflow/" title="Even Flow" class="md-nav__link">
      Even Flow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/pwn/impossible_shellcoding/" title="Impossible Shellcoding" class="md-nav__link">
      Impossible Shellcoding
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/crypto/BabyRSA/" title="BabyRSA" class="md-nav__link">
      BabyRSA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/crypto/BabyRSA2/" title="BabyRSA 2" class="md-nav__link">
      BabyRSA 2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/crypto/lossyoracle/" title="LossyOracle" class="md-nav__link">
      LossyOracle
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2" checked>
    
    <label class="md-nav__link" for="nav-2-2">
      CrossCTF 2018 Finals
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        CrossCTF 2018 Finals
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-2" type="checkbox" id="nav-2-2-2">
    
    <label class="md-nav__link" for="nav-2-2-2">
      Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-2">
        Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../pwn/ftlog/" title="FTLOG" class="md-nav__link">
      FTLOG
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pwn/slowmo/" title="Slowmo" class="md-nav__link">
      Slowmo
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pwn/cocacola/" title="Coca Cola" class="md-nav__link">
      Coca Cola
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pwn/gruffybear/" title="GruffyBear" class="md-nav__link">
      GruffyBear
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pwn/souvlaki/" title="Souvlaki Space Station" class="md-nav__link">
      Souvlaki Space Station
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-3" type="checkbox" id="nav-2-2-3" checked>
    
    <label class="md-nav__link" for="nav-2-2-3">
      Reversing
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-3">
        Reversing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../perfect/" title="Perfect" class="md-nav__link">
      Perfect
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../rochefort6/" title="Tower Of Beer: Rochefort 6" class="md-nav__link">
      Tower Of Beer: Rochefort 6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../rochefort8/" title="Tower Of Beer: Rochefort 8" class="md-nav__link">
      Tower Of Beer: Rochefort 8
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        iamrusty
      </label>
    
    <a href="./" title="iamrusty" class="md-nav__link md-nav__link--active">
      iamrusty
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analysis" class="md-nav__link">
    Analysis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apply-zigs" class="md-nav__link">
    Apply zigs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-main" class="md-nav__link">
    Find main
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#useful-pattern" class="md-nav__link">
    Useful pattern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-backtrace" class="md-nav__link">
    Using backtrace
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-function-in-r2" class="md-nav__link">
    Define function in r2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rust-main-break" class="md-nav__link">
    rust-main-break
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reverse-encryption" class="md-nav__link">
    Reverse encryption
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#output-tracing" class="md-nav__link">
    Output tracing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identify-relevant-code-blocks" class="md-nav__link">
    Identify relevant code blocks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    Solution
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-4" type="checkbox" id="nav-2-2-4">
    
    <label class="md-nav__link" for="nav-2-2-4">
      Web
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-4">
        Web
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../web/gocoin/" title="GoCoin!" class="md-nav__link">
      GoCoin!
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../web/gocoinplus/" title="GoCoin! Plus" class="md-nav__link">
      GoCoin! Plus
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../web/gocoinplusplus/" title="GoCoin! Plus Plus" class="md-nav__link">
      GoCoin! Plus Plus
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../web/terminal/" title="The Terminal" class="md-nav__link">
      The Terminal
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../web/retroweb/" title="RetroWeb" class="md-nav__link">
      RetroWeb
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../web/cachecreek/" title="CacheCreek" class="md-nav__link">
      CacheCreek
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-5" type="checkbox" id="nav-2-2-5">
    
    <label class="md-nav__link" for="nav-2-2-5">
      Crypto
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-5">
        Crypto
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../crypto/fitblips/" title="Fitblips" class="md-nav__link">
      Fitblips
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../crypto/babyrsa3/" title="BabyRSA" class="md-nav__link">
      BabyRSA
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-6" type="checkbox" id="nav-2-2-6">
    
    <label class="md-nav__link" for="nav-2-2-6">
      Misc
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-6">
        Misc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/evil/" title="The Evilness" class="md-nav__link">
      The Evilness
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/cyoa/cyoa.py" title="Choose Your Own Adventure" class="md-nav__link">
      Choose Your Own Adventure
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-7" type="checkbox" id="nav-2-2-7">
    
    <label class="md-nav__link" for="nav-2-2-7">
      Mobile
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-7">
        Mobile
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../mobile/human/" title="Human Powered Flag Generator" class="md-nav__link">
      Human Powered Flag Generator
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      GoogleCTF 2018 Qualifiers
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        GoogleCTF 2018 Qualifiers
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../googlectf-quals2018/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3-2" type="checkbox" id="nav-2-3-2">
    
    <label class="md-nav__link" for="nav-2-3-2">
      Reversing
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-3-2">
        Reversing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../googlectf-quals2018/re/shallweplayagame/" title="Shall we play a game" class="md-nav__link">
      Shall we play a game
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Organising
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Organising
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://github.com/nushosilayer8/geekcamp2018plus-ctf" title="Geekcamp 2018+ CTF" class="md-nav__link">
      Geekcamp 2018+ CTF
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../organising/geekcamp2019-ctf/call-for-challenges/" title="Geekcamp 2019 Call for Challenges" class="md-nav__link">
      Geekcamp 2019 Call for Challenges
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analysis" class="md-nav__link">
    Analysis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apply-zigs" class="md-nav__link">
    Apply zigs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-main" class="md-nav__link">
    Find main
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#useful-pattern" class="md-nav__link">
    Useful pattern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-backtrace" class="md-nav__link">
    Using backtrace
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-function-in-r2" class="md-nav__link">
    Define function in r2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rust-main-break" class="md-nav__link">
    rust-main-break
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reverse-encryption" class="md-nav__link">
    Reverse encryption
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#output-tracing" class="md-nav__link">
    Output tracing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identify-relevant-code-blocks" class="md-nav__link">
    Identify relevant code blocks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    Solution
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/nushosilayer8/writeups/edit/master/writeups/crossctf-finals2018/re/iamrusty/README.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="crossctf-finals-2018-rochefort-8-re">CrossCTF Finals 2018 : Rochefort 8 (re)</h1>
<blockquote>
<p>Decrypt the encrypted flag!</p>
<p>Creator - quanyang (@quanyang)</p>
<p><a href="./iamrusty">iamrusty</a></p>
<p>The encrypted flag is [193, 43, 110, 37, 49, 203, 177, 168, 213, 56, 111, 114, 136, 234, 91, 129, 74, 3, 134, 159, 134, 47, 53, 245, 103, 247, 251, 52, 198, 245, 208, 139, 188, 151, 208, 36, 109, 245, 48, 174, 123, 154]</p>
</blockquote>
<h2 id="summary">Summary</h2>
<p>We are given a stripped binary, which name suggests to be a Rust binary. Reversing it, we see that it performs some form of variation of RC4, and we will use it to decrypt our flag.</p>
<p>The steps taken to reverse this binary are:</p>
<ul>
<li><a href="#apply-zigs">Apply zignatures</a></li>
<li><a href="#find-main">Find <code>main</code></a></li>
<li><a href="#reverse-encryption">Reverse encryption algorithm</a></li>
<li><a href="#solution">Decrypt the flag</a></li>
</ul>
<h2 id="analysis">Analysis</h2>
<p>For this challenge, I used r2 as I am more familiar with it compared to IDA. Like usual, start by running <code>file</code> on the binary and executing it to see what it is about.</p>
<pre><code class="bash">$ file iamrusty 
iamrusty: ELF 64-bit LSB pie executable x86-64, version 1 (SYSV), statically linked, stripped
$ ./iamrusty   
[1]    28689 segmentation fault  ./iamrusty
</code></pre>

<p>We see that it is a statically linked, stripped binary. Weirdly, it crashes.</p>
<p>Anyways, load the binary in analysis mode in r2.</p>
<pre><code class="bash">$ r2 -A iamrusty
</code></pre>

<p>Then, use <code>afl</code> to check the functions.</p>
<pre><code>[0x0012be40]&gt; afl
0x0012be40    3 50           entry0
0x0012be72    7 62           fcn.0012be72
0x0012beb0   20 164          fcn.0012beb0
0x0012c01c    9 17   -&gt; 124  fcn.0012c01c
0x0012c02d   15 107  -&gt; 228  fcn.0012c02d
0x0012c098    1 34           fcn.0012c098
</code></pre>

<p>We see only 6 functions. There are a few possible reasons to this:</p>
<ul>
<li>The binary is statically linked and uses very minimal amount of library functions</li>
<li>The binary is written by hand</li>
<li>The binary is packed</li>
</ul>
<p>Looking into <code>entry0</code>, we see</p>
<p><img alt="entry0" src="images/entry0.png" /></p>
<p>We see some initialization and <code>call fcn.0012beb0</code>. Peeking into it in graph view, we see a rather complicated graph, and non-typical instructions like <code>call r11</code>. This eliminates the possiblity that it is hand-written assembly. It is also unlikely to be the first case, as normally there would be a <code>__libc_start_main</code> function call at the start.</p>
<p>Hence, we should explore the possibility that it is packed. Using <code>strings</code> on the binary, we see <code>UPX!</code> on the first line. Ah, it is a UPX packed binary. We can unpack it to analyse it.</p>
<pre><code class="bash">$ upx -d iamrusty -o unpacked
</code></pre>

<p>Now, running <code>file</code> again and executing the binary.</p>
<pre><code class="bash">$ file unpacked
unpacked: ELF 64-bit LSB pie executable x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=6d25298b54bfbbf751f73e6e0833e24961702770, stripped
$ ./unpacked
The encrypted flag is [213, 49, 96, 34, 11, 251, 177, 134, 203, 44, 118, 96, 155, 172]
</code></pre>

<p>Now this makes more sense. Let's also run <code>strings</code> on it. Doing so, we see strings like "jemalloc" or strings contaning "rs". So, we can confirm that this is a Rust binary.</p>
<h3 id="apply-zigs">Apply zigs</h3>
<p>Before starting to analyse the binary, since it is stripped, this means it will be very difficult to know what each function does. I made use of <a href="http://radare.today/posts/zignatures/">zignatures</a> to try to identify each function. The radare2 book has a more detailed <a href="https://radare.gitbooks.io/radare2book/content/signatures/zignatures.html">documentation</a> of the zignatures namespace.</p>
<p>I prepared a <a href="https://github.com/daniellimws/REsources/blob/master/zigs/rust/rust.z">zignature file</a> which contains the signatures of most commonly used Rust standard library functions.</p>
<p>To do this, don't load the binary in analysis mode, just plain <code>r2 ./unpacked</code>. Then, load the zignature file, apply it to our binary, and only after that use <code>aaa</code> to analyse it.</p>
<pre><code class="bash">[0x00006c01]&gt; zo /home/daniel/REsources/zigs/rust/rust.z 
[0x00006c01]&gt; z/
[+] searching 0x00000000 - 0x00063794
0x0000cb20 Sequencial hit ignored.
0x0000cb60 Sequencial hit ignored.
0x0000cb20 Sequencial hit ignored.
0x0000cb60 Sequencial hit ignored.
0x0000cb20 Sequencial hit ignored.
0x0000cb60 Sequencial hit ignored.
0x0000cb20 Sequencial hit ignored.
0x0000cb60 Sequencial hit ignored.
0x0000cb20 Sequencial hit ignored.
0x0000cb60 Sequencial hit ignored.
0x00014240 Sequencial hit ignored.
0x00014240 Sequencial hit ignored.
0x00014240 Sequencial hit ignored.
0x00014240 Sequencial hit ignored.
0x00014240 Sequencial hit ignored.
0x00014240 Sequencial hit ignored.
0x00015b00 Sequencial hit ignored.
0x00015b00 Sequencial hit ignored.
0x00017780 Sequencial hit ignored.
0x00017780 Sequencial hit ignored.
0x00017780 Sequencial hit ignored.
0x00017780 Sequencial hit ignored.
0x00017780 Sequencial hit ignored.
[+] searching 0x00263900 - 0x002683b8
[+] searching function metrics
hits: 206
[0x00006c01]&gt; aaa
[x] Analyze all flags starting with sym. and entry0 (aa)
[x] Analyze len bytes of instructions for references (aar)
[ WARNING : block size exceeding max block size at 0x0000d7a0
[+] Try changing it with e anal.bb.maxsize
[x] Analyze function calls (aac)
[x] Use -AA or aaaa to perform additional experimental analysis.
[x] Constructing a function name for fcn.* and sym.func.* functions (aan)
</code></pre>

<p>It is not perfect. It will not successfully label every single function in there, but it was really helpful in identifying functions like</p>
<pre><code class="c">sign.bytes.sym.core::fmt::Write::write_fmt::hda0de9044a822dbe_2
sign.bytes.sym.core::fmt::Formatter::pad_integral::__u7b__u7b_closure_u7d__u7d_::h405811ed46957e23_0
</code></pre>

<p>which helped a lot in guessing what a function does.</p>
<h3 id="find-main">Find main</h3>
<p>One major problem with this being a stripped binary means we don't know where <code>main</code> is, and it is not as obvious as typical C binaries. </p>
<p>Typically, for C binaries, the program will enter <code>main</code> after the call of <code>__libc_start_main</code>. However, for Rust, after <code>__libc_start_main</code>, the program does <strong>a lot</strong> of setting up, before going into the actual <code>main</code>. </p>
<p>And since it is a stripped binary, we won't know which function call is <code>main</code> or for setting up!</p>
<h4 id="useful-pattern">Useful pattern</h4>
<p>However, I am not completely stuck. From trying to reverse different simple Rust binaries I compiled myself, I noticed a very helpful pattern. It turns out that regardless of whatever or however much set up is being done at the start, before executing the actual <code>main</code>, Rust will execute the following instruction block.</p>
<pre><code class="asm">jmp QWORD PTR [rsi + 0x18]
... # a few instructions
call QWORD [rdi]
</code></pre>

<p>There will always be a <code>jmp</code> to <code>[rsi + 0x18]</code>, and after a few instructions that may differ depending on the binary, it will <code>call QWORD [rdi]</code>, bringing us into the real <code>main</code>.</p>
<h4 id="using-backtrace">Using backtrace</h4>
<p>Now that we have an idea of what to look for, we can further narrow down our search space by making use of the backtrace at the point where the program prints the encrypted flag. This is because the printing must be called inside <code>main</code>, so the address of an instruction that calls <code>main</code> will be inside the backtrace for sure.</p>
<p>For this part, I used GEF. To add a breakpoint when the encrypted is being printed, we can set a catchpoint at a <code>write</code> syscall.</p>
<pre><code class="bash">gef➤  catch syscall write
</code></pre>

<p>Then use <code>r</code> to start executing the binary, and <code>bt</code> to view the backtrace.</p>
<pre><code class="bash">gef➤  bt
#0  0x00007ffff7f7f291 in __libc_write (fd=0x1, buf=0x7ffff761c000, nbytes=0x57) at ../sysdeps/unix/sysv/linux/write.c:27
#1  0x0000555555560e9c in ?? ()
#2  0x0000555555562278 in ?? ()
#3  0x0000555555561568 in ?? ()
#4  0x000055555556a0f6 in ?? ()
#5  0x00005555555625db in ?? ()
#6  0x000055555556e696 in ?? ()
#7  0x000055555556eb43 in ?? ()
#8  0x000055555556ddb3 in ?? ()
#9  0x00007ffff7bbbb17 in __libc_start_main (main=0x55555556d7a0, argc=0x1, argv=0x7fffffffde68, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffde58) at ../csu/libc-start.c:310
#10 0x000055555555ac2a in ?? ()
</code></pre>

<p>No shortcuts here. We can start by looking at the function called after <code>__libc_start_main</code>, which is at #8. Because the addresses here are added with a base address, we can use <code>vmmap</code> to get the base address, which is <code>0x0000555555554000</code>. Subtracting it from the address at #8, we can inspect it in r2, at address <code>0x19db3</code>.</p>
<p><img alt="19db3" src="images/19db3.png" /></p>
<p>We see that before this instruction, <code>call fcn.000079b0</code> was being executed, so #7 is an address inside <code>fcn.000079b0</code>. Let's try to set a breakpoint at <code>0x19dae</code> and see if we can find the <code>jmp [rsi+0x18]</code> instruction from here. </p>
<p>Since the binary is a PIE, we can't set the breakpoint at <code>0x19dae</code> using <code>break *0x19dae</code>, since during execution there will be a base address added to it as seen earlier, and <code>0x19dae</code> will become an invalid address.</p>
<p>To do this, we can use <code>pie break *0x19dae</code> from gef, and <code>pie run</code> to run it with these settings.</p>
<p><img alt="19dae" src="images/19dae.png" /></p>
<p>Great! <code>jmp [rsi+0x18]</code> is close to us. Single stepping a few steps, we arrive at <code>call [rdi]</code>, which brings us into the actual program <code>main</code>, which is at <code>0x55555556dff0</code>, without the base address it is <code>0x19ff0</code>.</p>
<h4 id="define-function-in-r2">Define function in r2</h4>
<p>Now we are left with defining <code>0x19ff0</code> as a function in r2, and renaming it to <code>actual_main</code>. We can do this by seeking <code>0x19ff0</code> using <code>s 0x19ff0</code>, then entering visual mode using <code>V</code>, and pressing <code>df</code> to define function, lastly <code>dr</code> to rename function.</p>
<p>Once we are done with this, we can open up the graph view and actually start to reverse what the binary is doing.</p>
<h4 id="rust-main-break">rust-main-break</h4>
<p>Since I do not want to do this kind of searching all the time, I wrote a command for <a href="https://github.com/daniellimws/gef-extras/blob/rust-main-break/scripts/rustbreak.py"><code>gef-extras</code></a> that automates this process. It will look like something like the following</p>
<pre><code class="bash">gef➤  rust-main-break
[+] Breaking at '{&lt;text variable, no debug info&gt;} 0x5570 &lt;__libc_start_main@plt&gt;'
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.
[+] Searching for 'jmp QWORD PTR [rsi + 0x18]' instructions
[+] Trying 0x55555555b9b5
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.
0x000055555556eb40 in ?? ()
0x000055555556eb41 in ?? ()
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ registers ]────
$rax   : 0x0               
$rbx   : 0x5555557bb2c8      →  0x0000000000000000
$rcx   : 0x0               
$rdx   : 0x5555557bb2c8      →  0x0000000000000000
$rsp   : 0x7fffffffdc28      →  0x000055555556eb43  →   xor eax, eax
$rbp   : 0x7ffff7625000      →  0x0000000000000001
$rsi   : 0x5555557baae8      →  0x000055555556eb30  →   ret 
$rdi   : 0x7fffffffdcb8      →  0x000055555556dff0  →   push r14
$rip   : 0x55555556dff0      →   push r14
$r8    : 0x0               
$r9    : 0x800000000       
$r10   : 0xf               
$r11   : 0x7ffff7fe7990      →  &lt;_dl_find_dso_for_object+0&gt; push r13
$r12   : 0x7fffff7fe000    
$r13   : 0x1               
$r14   : 0x7fffffffdc40      →  0x0000000000000001
$r15   : 0x7fffff7ff000    
$eflags: [ZERO carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$fs: 0x0000  $gs: 0x0000  $es: 0x0000  $ds: 0x0000  $cs: 0x0033  $ss: 0x002b  
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ stack ]────
0x00007fffffffdc28│+0x00: 0x000055555556eb43  →   xor eax, eax   ← $rsp
0x00007fffffffdc30│+0x08: 0x0000000000000000
0x00007fffffffdc38│+0x10: 0x000055555556ddb3  →   mov ebx, eax
0x00007fffffffdc40│+0x18: 0x0000000000000001     ← $r14
0x00007fffffffdc48│+0x20: 0x00007fffff7fe000
0x00007fffffffdc50│+0x28: 0x00007fffff7ff000
0x00007fffffffdc58│+0x30: 0x00007ffff7625000  →  0x0000000000000001
0x00007fffffffdc60│+0x38: 0x00007fffffffde78  →  0x00007fffffffe205  →  &quot;XDG_RUNTIME_DIR=/run/user/1000&quot;
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ code:i386:x86-64 ]────
   0x55555556dfe0                  ud2    
   0x55555556dfe2                  nop    WORD PTR cs:[rax+rax*1+0x0]
   0x55555556dfec                  nop    DWORD PTR [rax+0x0]
 → 0x55555556dff0                  push   r14
   0x55555556dff2                  push   rbx
   0x55555556dff3                  sub    rsp, 0x298
   0x55555556dffa                  lea    rdi, [rsp+0x180]
   0x55555556e002                  xor    ebx, ebx
   0x55555556e004                  xor    esi, esi
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ threads ]────
[#0] Id 1, Name: &quot;unpacked&quot;, stopped, reason: SINGLE STEP
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ trace ]────
[#0] 0x55555556dff0 → push r14
[#1] 0x55555556eb43 → xor eax, eax
[#2] 0x55555556ddb3 → mov ebx, eax
[#3] 0x7ffff7bbbb17 → Name: __libc_start_main(main=0x55555556d7a0, argc=0x1, argv=0x7fffffffde68, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffde58)
[#4] 0x55555555ac2a → hlt 
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
0x000055555556dff0 in ?? ()
[+] Found 'main' at 0x55555556dff0
</code></pre>

<h3 id="reverse-encryption">Reverse encryption</h3>
<p>Now that we can analyse <code>main</code>, the next step is to reverse the encryption algorithm. At the start of the function, we see a few blocks of data are being copied to the stack.  </p>
<p><img alt="initperm" src="images/main_initperm.png" /></p>
<p>Inspecting those values,</p>
<pre><code class="bash">:&gt; ps @ 0x545b0
\x01\x02\x03\x04\x05\x06\x07\x08\x09
\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f !&quot;#$%&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff
</code></pre>

<p>it looks like the initial permutation of <a href="https://en.wikipedia.org/wiki/RC4">RC4</a>. It's something important to keep in mind, but not to quickly jump to conclusions yet.</p>
<p>(Actually, a hint was given that the encryption method is a variation of RC4)</p>
<h4 id="output-tracing">Output tracing</h4>
<p>At this point, what I decided to do, was to try to trace the output of the program, to see what is being done to it, and where did it come from. Again, I made use of the backtrace.</p>
<p>(For reference)</p>
<pre><code class="bash">gef➤  bt
#0  0x00007ffff7f7f291 in __libc_write (fd=0x1, buf=0x7ffff761c000, nbytes=0x57) at ../sysdeps/unix/sysv/linux/write.c:27
#1  0x0000555555560e9c in ?? ()
#2  0x0000555555562278 in ?? ()
#3  0x0000555555561568 in ?? ()
#4  0x000055555556a0f6 in ?? ()
#5  0x00005555555625db in ?? ()
#6  0x000055555556e696 in ?? ()
#7  0x000055555556eb43 in ?? ()
#8  0x000055555556ddb3 in ?? ()
#9  0x00007ffff7bbbb17 in __libc_start_main (main=0x55555556d7a0, argc=0x1, argv=0x7fffffffde68, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffde58) at ../csu/libc-start.c:310
#10 0x000055555555ac2a in ?? ()
</code></pre>

<p>This time, we want to find the address of the instruction in <code>actual_main</code> that calls a function that leads to printing the encrypted flag. After some checking, #6 is the one we are looking for. </p>
<p>In particular, <code>call fcn.0000e520</code> at <code>0x1a691</code>.</p>
<p><img alt="1a696" src="images/1a696.png" /></p>
<p>Now, the question is, is <code>fcn.0000e520</code> a printing function, or a function that further encrypts the flag then calls a printing function? To do this, we can inspect the registers and stack to see if we can find traces of the final encrypted flag. Let's set a breakpoint at <code>0x1a691</code> to inspect the stack before <code>fcn.0000e520</code> is called.</p>
<p>Looking at the registers, we see some optimistic results. In particular, <code>rdx</code> contains an address that leads to the string <code>"The encrypted flag is"</code>.</p>
<pre><code>$rax   : 0x7fffffffdad8      →  0x00007fffffffdae8  →  0x00007ffff762a000  →  0x86b1fb0b226031d5
$rbx   : 0x7ffff7625050      →  0x0000000000000002
$rcx   : 0x0               
$rdx   : 0x7fffffffdb00      →  0x00005555557baac8  →  0x00005555555aa900  →  &quot;The encrypted flag is \n/proc/curproc/file&quot;
$rsp   : 0x7fffffffd980      →  &quot;6999            557bc000 rw-p 00&quot;
$rbp   : 0x7ffff7625000      →  0x0000000000000001
$rsi   : 0x7fffffffd9b0      →  0x00007ffff7625050  →  0x0000000000000002
$rdi   : 0x7fffffffd990      →  &quot;557bc000 rw-p 00&quot;
$rip   : 0x55555556e691      →   call 0x555555562520
$r8    : 0x0               
$r9    : 0x61              
$r10   : 0x310             
$r11   : 0xcc              
$r12   : 0x7fffff7fe000    
$r13   : 0x1               
$r14   : 0x7fffffffdc40      →  0x0000000000000001
$r15   : 0x7fffff7ff000    
$eflags: [zero carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$fs: 0x0000  $gs: 0x0000  $es: 0x0000  $ds: 0x0000  $cs: 0x0033  $ss: 0x002b  
</code></pre>

<p>It seems like the address contained in <code>rdx</code> may contain our encrypted flag. Using <code>telescope</code> from gef, we can easily inspect the contents in the address contained by <code>rdx</code>.</p>
<pre><code>gef➤  telescope $rdx
0x00007fffffffdb00│+0x00: 0x00005555557baac8  →  0x00005555555aa900  →  &quot;The encrypted flag is \n/proc/curproc/file&quot;     ← $rdx
0x00007fffffffdb08│+0x08: 0x0000000000000002
0x00007fffffffdb10│+0x10: 0x00005555555aa8c0  →   add DWORD PTR [rax], eax
0x00007fffffffdb18│+0x18: 0x0000000000000001
0x00007fffffffdb20│+0x20: 0x00007fffffffdad8  →  0x00007fffffffdae8  →  0x00007ffff762a000  →  0x86b1fb0b226031d5
0x00007fffffffdb28│+0x28: 0x0000000000000001
0x00007fffffffdb30│+0x30: 0x8754a2a1c8a40fb0
0x00007fffffffdb38│+0x38: 0x573deb40f0ec6a78
0x00007fffffffdb40│+0x40: 0x05bb44d0048dce4d
0x00007fffffffdb48│+0x48: 0xc9343efffc4b7fed
</code></pre>

<p>We see some numbers at <code>$rdx + 0x30</code>. Let's check the decimal values of some bytes in there.</p>
<pre><code>gef➤  x/10db $rdx+0x30
0x7fffffffdb30: -80 15  -92 -56 -95 -94 84  -121
0x7fffffffdb38: 120 106
gef➤  x/10ub $rdx+0x30
0x7fffffffdb30: 176 15  164 200 161 162 84  135
0x7fffffffdb38: 120 106
</code></pre>

<p>Our program output is </p>
<pre><code class="bash">$ ./unpacked
The encrypted flag is [213, 49, 96, 34, 11, 251, 177, 134, 203, 44, 118, 96, 155, 172]
</code></pre>

<p>Sadly, those numbers do not match our program output. However, making some observations, we see that there is another set of possible numbers contained in the address at <code>$rdx + 0x20</code>.</p>
<pre><code>gef➤  x/10ub 0x00007ffff762a000
0x7ffff762a000: 213 49  96  34  11  251 177 134
0x7ffff762a008: 203 44
</code></pre>

<p>It matches! Our encrypted flag is contained in <code>0x00007ffff762a000</code>!</p>
<h4 id="identify-relevant-code-blocks">Identify relevant code blocks</h4>
<p>We are very close! Now, we can follow on by <strong>checking which part of the code affects this block of memory</strong>, then from there reverse the encryption algorithm.</p>
<p>Typically in Rust binaries, there are a lot of functions that call <code>pthread</code> functions within them. Normally, we can ignore these functions as they are just used by Rust for things like safety checking or error handling.</p>
<p>There are several ways we can identify the code blocks that are relevant. We can instrument the binary to stop when the contents in that memory block matches the encrypted flag. This can be done using tools like <code>angr</code> or GDB scripting. I chose to just manually set some breakpoints and check by hand.</p>
<p>Doing so, I managed to identify that the blocks that matter in the CFG are</p>
<p><img alt="" src="images/main_initperm.png" /> <img alt="" src="images/main_ksa.png" /> <img alt="" src="images/main_malloc.png" /> <img alt="" src="images/main_prga.png" /></p>
<p>If we look at the Wikipedia <a href="https://en.wikipedia.org/wiki/RC4">entry</a> of RC4, the first block prepares the initial permutation. The second block is the KSA (Key scheduling algorithm). The third block performs some form of malloc-like operation that returns the address of the block containing our encrypted flag. The final block is the PRGA (pseudo-random generation algorithm) part.</p>
<p>Looking at the PRGA block, we see occurences of <code>xor</code> instructions. This should be the flag, being encrypted by the output of the PRGA. If we piece them together, we get the string <code>WhatIsTheFlag?</code>.</p>
<h3 id="conclusion">Conclusion</h3>
<p>We are done with reversing. This binary shows us the encryption method used to encrypt the string <code>WhatIsTheFlag?</code>. Now we need to decrypt the actual flag given </p>
<pre><code>[193, 43, 110, 37, 49, 203, 177, 168, 213, 56, 111, 114, 136, 234, 91, 129, 74, 3, 134, 159, 134, 47, 53, 245, 103, 247, 251, 52, 198, 245, 208, 139, 188, 151, 208, 36, 109, 245, 48, 174, 123, 154]
</code></pre>

<p>To sum up, the encryption algorithm is based on RC4,</p>
<ul>
<li>Sets up an initial permutation</li>
<li>Swaps values in the initial permutation around for 256 iterations (Key scheduling)</li>
<li>For each character in the flag, obtain a corresponding key byte after swapping some values in the permutation again (Pseudo-random generation), then xors it with the flag to produce the ciphertext</li>
</ul>
<h2 id="solution">Solution</h2>
<p>Now, we are left with writing a script to generate the keystream based on the one given in the binary, in order to decrypt the actual flag.</p>
<p>Since the key scheduling part (block 2) is just setting up the permutation for the random number generation, we can let the program execute until that is done, then dump the memory containing the permutation to a file.</p>
<p>Looking at the disassembly, we see that the key schedule is being stored in <code>rsp + 0x182</code>. So, we can just set a breakpoint at the start of block 3 (i.e. when block 2 finishes), and then dump the contents in that memory block to a file.</p>
<pre><code class="bash">gef➤  pie break *0x1a187
gef➤  pie run
gef➤  dump memory key_schedule $rsp+0x182 $rsp+0x182+256
</code></pre>

<p>Then, we got to write a function to emulate the PRGA part. This part is just purely reversing the disassembly, nothing special.</p>
<pre><code class="python">key_index = 0
key_index2 = 0
key_schedule = map(ord, list(open('key_schedule', 'r').read()))

def get_key():
    global key_index, key_index2, key_schedule
    key_index = (key_index + 1) % 256
    key_index2 = (key_index2 + key_schedule[key_index]) % 256

    key_schedule[key_index2], key_schedule[key_index] = key_schedule[key_index], key_schedule[key_index2]
    return key_schedule[(key_schedule[key_index] + key_schedule[key_index2]) % 256]
</code></pre>

<p>And lastly, print the flag.</p>
<pre><code class="python">if __name__ == '__main__':
    c = [193, 43, 110, 37, 49, 203, 177, 168, 213, 56, 111, 114, 136, 234, 91, 129, 74, 3, 134, 159, 134, 47, 53, 245, 103, 247, 251, 52, 198, 245, 208, 139, 188, 151, 208, 36, 109, 245, 48, 174, 123, 154]
    flag = ''
    for i in xrange(len(c)):
        flag += chr(c[i] ^ get_key())

    print flag
</code></pre>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../rochefort8/" title="Tower Of Beer: Rochefort 8" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Tower Of Beer: Rochefort 8
              </span>
            </div>
          </a>
        
        
          <a href="../../web/gocoin/" title="GoCoin!" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                GoCoin!
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.c648116f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
    
  </body>
</html>