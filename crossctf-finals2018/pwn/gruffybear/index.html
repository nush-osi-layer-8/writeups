



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://nush-osi-layer-8.github.io/writeups/crossctf-finals2018/pwn/gruffybear/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.9.0">
    
    
      
        <title>CrossCTF Finals 2018 : GruffyBear (Pwn) - OSI Layer 8</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.4f4f49e8.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.6079476c.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="light-blue" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#crossctf-finals-2018-gruffybear-pwn" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://nush-osi-layer-8.github.io/writeups/" title="OSI Layer 8" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                OSI Layer 8
              </span>
              <span class="md-header-nav__topic">
                CrossCTF Finals 2018 : GruffyBear (Pwn)
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/nush-osi-layer-8/writeups/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    OSI Layer 8
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/nush-osi-layer-8/writeups/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="OSI Layer 8" class="md-nav__link">
      OSI Layer 8
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Crossctf finals2018
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Crossctf finals2018
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      Crypto
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        Crypto
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-1" type="checkbox" id="nav-2-1-1">
    
    <label class="md-nav__link" for="nav-2-1-1">
      Babyrsa3
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-1">
        Babyrsa3
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../crypto/babyrsa3/" title="CrossCTF Finals 2018 : BabyRSA3 (crypto)" class="md-nav__link">
      CrossCTF Finals 2018 : BabyRSA3 (crypto)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2" checked>
    
    <label class="md-nav__link" for="nav-2-2">
      Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-1" type="checkbox" id="nav-2-2-1">
    
    <label class="md-nav__link" for="nav-2-2-1">
      Cocacola
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-1">
        Cocacola
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../cocacola/" title="CrossCTF Finals 2018 : Coca Cola (Pwn)" class="md-nav__link">
      CrossCTF Finals 2018 : Coca Cola (Pwn)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-2" type="checkbox" id="nav-2-2-2">
    
    <label class="md-nav__link" for="nav-2-2-2">
      Ftlog
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-2">
        Ftlog
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../ftlog/" title="CrossCTF Finals 2018 : FTLOG (Pwn)" class="md-nav__link">
      CrossCTF Finals 2018 : FTLOG (Pwn)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-3" type="checkbox" id="nav-2-2-3" checked>
    
    <label class="md-nav__link" for="nav-2-2-3">
      Gruffybear
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-3">
        Gruffybear
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        CrossCTF Finals 2018 : GruffyBear (Pwn)
      </label>
    
    <a href="./" title="CrossCTF Finals 2018 : GruffyBear (Pwn)" class="md-nav__link md-nav__link--active">
      CrossCTF Finals 2018 : GruffyBear (Pwn)
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#first-blood-by-n0x10u5-g4s3s" title="First Blood by : N0X10U5 G4S3S" class="md-nav__link">
    First Blood by : N0X10U5 G4S3S
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#static-analysis" title="Static Analysis" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" title="Solution" class="md-nav__link">
    Solution
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      Re
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        Re
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3-1" type="checkbox" id="nav-2-3-1">
    
    <label class="md-nav__link" for="nav-2-3-1">
      Perfect
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-3-1">
        Perfect
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../re/perfect/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3-2" type="checkbox" id="nav-2-3-2">
    
    <label class="md-nav__link" for="nav-2-3-2">
      Rochefort6
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-3-2">
        Rochefort6
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../re/rochefort6/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Crossctf quals2018
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Crossctf quals2018
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      CYOA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        CYOA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/CYOA/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Crypto
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Crypto
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3-1" type="checkbox" id="nav-3-3-1">
    
    <label class="md-nav__link" for="nav-3-3-1">
      BabyRSA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-3-1">
        BabyRSA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/crypto/BabyRSA/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3-2" type="checkbox" id="nav-3-3-2">
    
    <label class="md-nav__link" for="nav-3-3-2">
      BabyRSA2
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-3-2">
        BabyRSA2
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/crypto/BabyRSA2/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3-3" type="checkbox" id="nav-3-3-3">
    
    <label class="md-nav__link" for="nav-3-3-3">
      Lossyoracle
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-3-3">
        Lossyoracle
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/crypto/lossyoracle/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-1" type="checkbox" id="nav-3-4-1">
    
    <label class="md-nav__link" for="nav-3-4-1">
      Evenflow
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-1">
        Evenflow
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/pwn/evenflow/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-2" type="checkbox" id="nav-3-4-2">
    
    <label class="md-nav__link" for="nav-3-4-2">
      Impossible shellcoding
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-2">
        Impossible shellcoding
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crossctf-quals2018/pwn/impossible_shellcoding/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#first-blood-by-n0x10u5-g4s3s" title="First Blood by : N0X10U5 G4S3S" class="md-nav__link">
    First Blood by : N0X10U5 G4S3S
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#static-analysis" title="Static Analysis" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" title="Solution" class="md-nav__link">
    Solution
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/nush-osi-layer-8/writeups/edit/master/docs/crossctf-finals2018/pwn/gruffybear/README.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="crossctf-finals-2018-gruffybear-pwn">CrossCTF Finals 2018 : GruffyBear (Pwn)</h1>
<h3 id="first-blood-by-n0x10u5-g4s3s">First Blood by : N0X10U5 G4S3S</h3>
<blockquote>
<p>There's something fishy about this Build-A-Bear workshop...</p>
<p>nc ctf.pwn.sg 4002</p>
<p>Creator - amon (@nn_amon)</p>
</blockquote>
<h2 id="static-analysis">Static Analysis</h2>
<p>Running <code>file gruffybear</code> gives:</p>
<pre><code>gruffybear: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter ld-2.23.so, for GNU/Linux 2.6.32, BuildID[sha1]=405edd7cd41e309d1cab442ffc6a6dad8e782908, not stripped
</code></pre>

<p>The code:</p>
<pre><code class="c">int __cdecl main(int argc, const char **argv, const char **envp)
{
  int v4; // [rsp+4h] [rbp-24h]
  unsigned __int64 v5; // [rsp+8h] [rbp-20h]

  v5 = __readfsqword(0x28u);
  setvbuf(stdin, 0LL, 2, 0LL);
  setvbuf(stdout, 0LL, 2, 0LL);
  setvbuf(stderr, 0LL, 2, 0LL);
  v4 = 999;
  alarm(0x3Cu);
LABEL_2:
  while ( v4 )
  {
    while ( 2 )
    {
      print_banner();
      _isoc99_scanf(&quot;%d&quot;, &amp;v4);
      switch ( v4 )
      {
        case 1:
          build_bear();
          goto LABEL_2;
        case 2:
          select_bear();
          goto LABEL_2;
        case 3:
          delete_bear();
          goto LABEL_2;
        case 4:
          print_bear();
          goto LABEL_2;
        case 5:
          add_comment();
          goto LABEL_2;
        case 6:
          print_comment();
          goto LABEL_2;
        case 7:
          destruction();
          if ( !v4 )
            return 0;
          continue;
        default:
          puts(&quot;Nothing to do.&quot;);
          break;
      }
      break;
    }
  }
  return 0;
}
</code></pre>

<p><code>main()</code> does some setup like turning off buffering, and calling <code>alarm(0x3cu)</code>. This sets us on a time limit, after which the program will crash.</p>
<blockquote>
<p>Make sure to <code>nop</code> the call to <code>alarm()</code> using your tool. e.g. in <code>radare2</code> you would go to the address of the call then <code>wx 9090909090</code> .</p>
</blockquote>
<p>In a loop, we print a banner, then get input. Based on the input, we call functions. This is a typical menu-based cli program.</p>
<pre><code class="c">unsigned __int64 build_bear()
{
  __int64 v0; // rbp
  bear *v1; // rbx
  const char *v3; // rbx
  char buf; // [rsp+7h] [rbp-21h]
  unsigned __int64 v5; // [rsp+8h] [rbp-20h]

  v5 = __readfsqword(0x28u);
  v0 = num_bears[0];
  if ( num_bears[0] &gt; 12 )
  {
    v3 = &quot;SUNIATRETNE&quot;;
    _printf_chk(1LL, &quot;Here we are now... &quot;);
    while ( 1 )
    {
      read(0, &amp;buf, 1uLL);
      if ( v3[10] != buf )
        break;
      if ( --v3 == &quot;nt&quot; )
      {
        read(0, &amp;buf, 1uLL);
        admin_enabled = 1;
        return __readfsqword(0x28u) ^ v5;
      }
    }
  }
  else
  {
    v1 = (bear *)calloc(1uLL, 0xB8uLL);
    bears[v0] = v1;
    _printf_chk(1LL, &quot;Bear Name: &quot;);
    read(0, v1, 0x1FuLL);
    _printf_chk(1LL, &quot;Bear ID: &quot;);
    _isoc99_scanf(&quot;%x&quot;, &amp;v1-&gt;id);
    _printf_chk(1LL, &quot;Bear Age: &quot;);
    _isoc99_scanf(&quot;%d&quot;, &amp;v1-&gt;age);
    _printf_chk(1LL, &quot;Bear Description: &quot;);
    read(0, v1-&gt;description, 0x80uLL);
    v1-&gt;free_function = (__int64)&amp;free;
    v1-&gt;self_destruct_device_ptr = (__int64)self_destruct_device;
    puts(&quot;Bear created!&quot;);
    ++num_bears[0];
  }
  return __readfsqword(0x28u) ^ v5;
}
</code></pre>

<p>The typical functionality of <code>build_bear()</code> is to allocate <code>0xb8</code> size of memory using malloc() then initialize it using user-provided values, then set the global <code>bears</code> array's last unused element to our the address of the bear (<code>bears[v0]=v1</code>, where v0 is the ```num_bears). The 'bear' struct seems to as follows:</p>
<pre><code>struct bear{
    char name[32];
    int id;
    int age;
    char desc[128];
    void* free_ptr;
    void* self_destruct_device_ptr;
}
</code></pre>

<p>Once we have 13 bears built already, we enter some sort of secret section, which lets us set <code>admin_enabled</code> to 1, as long as we satisfy some checks. In short, what the checks really want are the characters of "SUNIATRETNE" in reverse.</p>
<blockquote>
<p>IDA Pro sometimes goofs up its decompiler. What the <code>v3-- == "nt"</code> really means is <code>v3-- == (__int64)SUNIATRETNE"-1</code>, or whether v3-- points to the byte before the "S".</p>
<p>The above can be simplified to</p>
</blockquote>
<pre><code class="c">v3 = (__int64)&quot;SUNIATRETNE&quot;; // v3 is a POINTER
_printf_chk(1LL, &quot;Here we are now... &quot;);
while ( 1 )
{
    read(0, &amp;buf, 1uLL);
    if ( v3[10] != buf )
        break;
    if ( --v3 == (__int64)&quot;SUNIATRETNE&quot;-1)
    {
        read(0, &amp;buf, 1uLL);
        admin_enabled = 1;
        return __readfsqword(0x28u) ^ v5;
    }
}
</code></pre>

<p>On to the next function ...</p>
<pre><code class="c">unsigned __int64 select_bear()
{
  unsigned int v1; // [rsp+4h] [rbp-14h]
  unsigned __int64 v2; // [rsp+8h] [rbp-10h]

  v2 = __readfsqword(0x28u);
  v1 = 0;
  _printf_chk(1LL, &quot;Selection: &quot;);
  _isoc99_scanf(&quot;%d&quot;, &amp;v1);
  if ( (v1 &amp; 0x80000000) == 0 &amp;&amp; v1 &lt; *num_bears )
    selected_bear = (void *)bears[v1];
  else
    puts(&quot;Not enough bears.&quot;);
  return __readfsqword(0x28u) ^ v2;
}
</code></pre>

<p>The program reads in a number, lets say <code>a</code>. If it is not negative and if it is lesser than num_bears, selected_bear will now have a copy of the pointer to the bear at index <code>a</code>. Else, it prints out "Not enough bears".</p>
<blockquote>
<p><code>(v1 &amp; 0x800000000)==0</code> means <code>first bit of v1 == 0</code>, and the first bit of a integer is its sign bit, according to 2s complement notation.</p>
</blockquote>
<pre><code class="c">int delete_bear()
{
  if ( !selected_bear )
    return puts(&quot;No bear selected!&quot;);
  _printf_chk(1LL, &quot;Deleting [%s]...\n&quot;);
  if ( (void (**)(void *))selected_bear-&gt;free_function == &amp;free )
    free(selected_bear);
  return puts(&quot;Deleted!&quot;);
}
</code></pre>

<p>The function <code>free()'s</code> the pointer in <code>selected_bear</code>, as long as the <code>free_function</code> still points to free.</p>
<blockquote>
<p>The <code>selected_bear</code> is not zero'ed out.
<br>The <code>bears[idx]</code> is not zero'ed out.
<br><strong>This challenge is a typical UAF challenge.</strong>
<br><code>num_bears</code> is not decremented</p>
</blockquote>
<pre><code class="c">int print_bear()
{
  __int64 v0; // rdx
  __int64 v1; // rdx

  if ( !selected_bear )
    return puts(&quot;No bear selected!&quot;);
  puts(art);
  _printf_chk(1LL, &quot;You have selected: [%s]\n&quot;);
  v0 = (unsigned int)selected_bear-&gt;id;
  _printf_chk(1LL, &quot;It's ID is %x\n&quot;);
  v1 = (unsigned int)selected_bear-&gt;age;
  _printf_chk(1LL, &quot;It's AGE is %d\n&quot;);
  return _printf_chk(1LL, &quot;It's DESCRIPTION is %s\n&quot;);
}
</code></pre>

<p>This function just prints out information about the <code>selected_bear</code>.</p>
<pre><code class="c">unsigned __int64 add_comment()
{
  unsigned int nbytes;

  _printf_chk(1LL, &quot;How long should the comment be: &quot;);
  _isoc99_scanf(&quot;%d&quot;, &amp;nbytes);
  comment = calloc(nbytes + 1, 1uLL);
  _printf_chk(1LL, &quot;Comment: &quot;);
  read(0, comment, nbytes[0]);
  return;
}
</code></pre>

<p>Here comes the main tool to exploit the UAF vulneraribility. This function reads in a number then calls <code>calloc(nbytes+1, 1)</code>, which is the same as <code>malloc(nbytes+1)</code>.</p>
<blockquote>
<p>If we <code>delete_bear()</code> then <code>add_comment()</code> of size <code>0xb8-1</code>, we can control ALL OF THE BEAR, including its <code>self_destruct_device_ptr</code>, which will be called later on...
<br> <em>Insert evil laugh here</em></p>
</blockquote>
<pre><code class="c">int print_comment()
{
  int result; // eax

  if ( comment )
    result = puts((const char *)comment);
  else
    result = puts(&quot;No&quot;);
  return result;
}
</code></pre>

<p>Pretty basic, prints the comment or prints "No" if theres no comment.</p>
<pre><code class="c">int destruction()
{
  int result; // eax

  if ( !admin_enabled )
    return puts(&quot;Nothing to do&quot;);
  result = (signed int)selected_bear;
  if ( selected_bear )
    result = (selected_bear-&gt;self_destruct_device_ptr)(*num_bears);
  return result;
}
</code></pre>

<p>If <code>admin_enabled</code> is true and <code>selected_bear</code> is valid,
we can execute <code>selected_bear</code>'s <code>self_destruct_device_ptr</code></p>
<h2 id="solution">Solution</h2>
<p>As mentioned earlier, this is a typical UAF challenge. The obvious steps so far are:
1. Build Bear 
    1. Put arbitrary data
2. Select Bear
    1. Select 0
3. Delete Bear
4. Add Comment
    1. The size of the comment must be <code>0xb8-1</code>, so that we <code>calloc(0xb8,1)</code> and so that it will reuse the free memory that belonged to <code>bears[0]</code>
    2. We can send <code>0xb0</code> arbitrary bytes, then send our desired function pointer, let's say, <code>0xcafebabe</code>
5. We call Build Bear 12 more times
    1. Put arbitrary data again
6. Build Bear (we already have 13 bears, this will go to the secret section now)
    1. This time, we send <code>SUNIATRETNE</code> in reverse, and this will set admin_enabled to 1
7. Destruction</p>
<p>Now the question is, what do we want to execute?</p>
<p>There isn't any function that can give shell, and we don't know the address of any function since it is a PIE binary anyway</p>
<pre><code>$ checksec gruffybear
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
    FORTIFY:  Enabled
</code></pre>

<p>Lets go hunting for a leak!</p>
<p>Actually thats really easy, since we are freeing a <a href="https://heap-exploitation.dhavalkapil.com/diving_into_glibc_heap/bins_chunks.html">smallbin-sized chunk (0xb8 = 184)</a>. If you see the structure of a free malloc_chunk in the smallbin size range, the first 8 bytes are a pointer to the smallbin, called <a href="https://heap-exploitation.dhavalkapil.com/diving_into_glibc_heap/malloc_chunk.html">fd</a>, which are the first 8 bytes of the bear's name.
To do this, we need to allocate another chunk first (build another bear) so that the chunk above ours is not the top chunk.</p>
<p>We can use <code>print_bear()</code> to leak this address, then call a libc function.</p>
<p>So now, do we call system()? We can't though, since we are passing the num_bears as its argument. Instead, we can use something called 'magic gadgets', which are places in libc we can jump to so that we can instantly get shell as long as some constraints are valid.</p>
<p>I use the tool <code>one_gadget</code> to do this.</p>
<pre><code>$ one_gadget libc-2.23.so
0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)
constraints:
  rax == NULL

0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)
constraints:
  [rsp+0x30] == NULL

0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)
constraints:
  [rsp+0x50] == NULL

0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL
</code></pre>

<p>I chose the second last one (it was at random)</p>
<p>So now, our steps are as follows
1. Build Bear 
    1. Put arbitrary data
1. Build Bear 
    1. Put arbitrary data
2. Select Bear
    1. Select 0
3. Delete Bear
4. Print Bear
    1. This will give us the libc smallbin address for size 0xb8 (in the name)
    2. This address is also 0x70+__realloc_hook, which was the calculation I used
4. Add Comment
    1. The size of the comment must be <code>0xb8-1</code>, so that we <code>calloc(0xb8,1)</code> and so that it will reuse the free memory that belonged to <code>bears[0]</code>
    2. We can send <code>0xb0</code> arbitrary bytes, then send our desired function pointer, which is <code>libc_base+0xf02a4</code>
    3. It only reads in 0xb7 bytes, so remember to remove the last byte from the input (its a null byte anyway)
5. We call Build Bear 11 more times
    1. Put arbitrary data again
6. Build Bear (we already have 13 bears, this will go to the secret section now)
    1. This time, we send <code>SUNIATRETNE</code> in reverse, and this will set admin_enabled to 1
7. Destruction</p>
<p>The final solution is in <a href="../gruffybear.py">here</a></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../ftlog/" title="CrossCTF Finals 2018 : FTLOG (Pwn)" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                CrossCTF Finals 2018 : FTLOG (Pwn)
              </span>
            </div>
          </a>
        
        
          <a href="../../re/perfect/" title="Home" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Home
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.a59e2a89.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:"../../.."}})</script>
      
    
    
      
    
  </body>
</html>